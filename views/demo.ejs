<%- include('partials/header', { title: 'Stream Demo - Chef AI', currentPage: 'demo' }) %>

<style>
    .input-group {
        margin-bottom: 20px;
    }
    
    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    
    input, select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
    }
    
    input:focus, select:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .btn-primary {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .btn-primary:hover { transform: translateY(-2px); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    
    .progress-container {
        margin-top: 30px;
        display: none;
    }
    
    .progress-container.active { display: block; }
    
    .progress-bar-wrapper {
        background: #f0f0f0;
        border-radius: 10px;
        height: 30px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }
    
    .phase-item {
        padding: 15px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #e0e0e0;
        opacity: 0.5;
        transition: all 0.3s;
        position: relative;
    }
    
    .phase-item.active {
        opacity: 1;
        border-left-color: #667eea;
        background: #f0f4ff;
    }
    
    .phase-item.complete {
        opacity: 1;
        border-left-color: #10b981;
        background: #f0fdf4;
    }
    
    .phase-item.error {
        opacity: 1;
        border-left-color: #ef4444;
        background: #fee2e2;
    }
    
    .phase-loader {
        display: none;
        width: 18px;
        height: 18px;
        border: 3px solid #e0e0e0;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        position: absolute;
        right: 15px;
        top: 18px;
    }
    
    .phase-item.active .phase-loader {
        display: block;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .error-banner {
        background: #fee2e2;
        color: #991b1b;
        padding: 15px 20px;
        border-radius: 8px;
        border-left: 4px solid #ef4444;
        margin: 20px 0;
        display: none;
        align-items: center;
        gap: 10px;
    }
    
    .error-banner.show {
        display: flex;
    }
    
    .error-banner strong {
        font-weight: 700;
    }
    
    .result-container {
        margin-top: 30px;
        display: none;
    }
    
    .result-container.active { display: block; }
    
    .recipe-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
    }
    
    .recipe-title {
        font-size: 24px;
        color: #667eea;
        font-weight: 700;
        margin-bottom: 15px;
    }
    
    .recipe-meta {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .recipe-meta span {
        background: white;
        padding: 8px 14px;
        border-radius: 6px;
        font-size: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .recipe-section {
        margin-bottom: 25px;
    }
    
    .recipe-section h3 {
        color: #333;
        margin-bottom: 12px;
    }
    
    .ingredient-item, .step-item {
        padding: 12px;
        background: white;
        margin-bottom: 8px;
        border-radius: 8px;
    }
    
    .step-item {
        border-left: 3px solid #667eea;
    }
</style>

<h1 style="color: #667eea; margin-bottom: 10px;">üé¨ SSE Streaming Demo</h1>
<p style="color: #666; margin-bottom: 30px;">Xem ti·∫øn tr√¨nh t·∫°o c√¥ng th·ª©c real-time</p>

<div class="input-group">
    <label for="dishName">T√™n m√≥n ƒÉn</label>
    <input type="text" id="dishName" placeholder="V√≠ d·ª•: Ph·ªü B√≤, B√∫n Ch·∫£..." value="<%= defaultDish || '' %>" />
</div>

<div class="input-group">
    <label for="categories">Th·ªÉ lo·∫°i</label>
    <select id="categories" multiple size="3">
        <option value="quick">Quick (Nhanh)</option>
        <option value="easy">Easy (D·ªÖ l√†m)</option>
        <option value="healthy">Healthy (L√†nh m·∫°nh)</option>
    </select>
</div>

<div class="input-group">
    <label for="servingSize">S·ªë l∆∞·ª£ng ng∆∞·ªùi ƒÉn</label>
    <select id="servingSize">
        <option value="">M·∫∑c ƒë·ªãnh (2-4 ng∆∞·ªùi)</option>
        <option value="1">1 ng∆∞·ªùi</option>
        <option value="2">2 ng∆∞·ªùi</option>
        <option value="4" selected>4 ng∆∞·ªùi</option>
        <option value="6">6 ng∆∞·ªùi</option>
        <option value="8">8 ng∆∞·ªùi</option>
        <option value="10">10 ng∆∞·ªùi</option>
    </select>
</div>

<div class="input-group">
    <label for="language">Ng√¥n ng·ªØ</label>
    <select id="language">
        <option value="vi" selected>Ti·∫øng Vi·ªát</option>
        <option value="eng">English</option>
    </select>
</div>

<button class="btn-primary" id="generateBtn" onclick="generateRecipe()">üöÄ T·∫°o c√¥ng th·ª©c</button>

<div class="progress-container" id="progressContainer">
    <div class="error-banner" id="errorBanner">
        <span style="font-size: 24px;">‚ùå</span>
        <div>
            <strong>L·ªói:</strong>
            <span id="errorMessage"></span>
        </div>
    </div>
    
    <div class="progress-bar-wrapper">
        <div class="progress-bar" id="progressBar">0%</div>
    </div>
    
    <div id="phasesList">
        <div class="phase-item" id="phase-1">
            <div style="font-weight: 600;">1Ô∏è‚É£ Chu·∫©n b·ªã</div>
            <div style="color: #666; font-size: 14px; margin-top: 5px;" class="phase-message">ƒêang ch·ªù...</div>
            <div class="phase-loader"></div>
        </div>
        <div class="phase-item" id="phase-2">
            <div style="font-weight: 600;">2Ô∏è‚É£ T√¨m ki·∫øm RAG</div>
            <div style="color: #666; font-size: 14px; margin-top: 5px;" class="phase-message">ƒêang ch·ªù...</div>
            <div class="phase-loader"></div>
        </div>
        <div class="phase-item" id="phase-3">
            <div style="font-weight: 600;">3Ô∏è‚É£ T·∫°o c√¥ng th·ª©c v·ªõi AI</div>
            <div style="color: #666; font-size: 14px; margin-top: 5px;" class="phase-message">ƒêang ch·ªù...</div>
            <div class="phase-loader"></div>
        </div>
        <div class="phase-item" id="phase-4">
            <div style="font-weight: 600;">4Ô∏è‚É£ Ho√†n thi·ªán</div>
            <div style="color: #666; font-size: 14px; margin-top: 5px;" class="phase-message">ƒêang ch·ªù...</div>
            <div class="phase-loader"></div>
        </div>
        <div class="phase-item" id="phase-5">
            <div style="font-weight: 600;">5Ô∏è‚É£ Ho√†n th√†nh</div>
            <div style="color: #666; font-size: 14px; margin-top: 5px;" class="phase-message">ƒêang ch·ªù...</div>
            <div class="phase-loader"></div>
        </div>
    </div>
</div>

<div class="result-container" id="resultContainer">
    <div class="recipe-card" id="recipeCard"></div>
</div>

<script>
    const API_URL = '<%= apiUrl %>';
    
    function generateRecipe() {
        const dishName = document.getElementById('dishName').value;
        const categories = Array.from(document.getElementById('categories').selectedOptions).map(opt => opt.value);
        const language = document.getElementById('language').value;
        const servingSizeValue = document.getElementById('servingSize').value;
        const servingSize = servingSizeValue ? parseInt(servingSizeValue) : undefined;
        
        if (!dishName) {
            alert('Vui l√≤ng nh·∫≠p t√™n m√≥n ƒÉn!');
            return;
        }
        
        // Reset UI
        document.getElementById('progressContainer').classList.add('active');
        document.getElementById('resultContainer').classList.remove('active');
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('errorBanner').classList.remove('show');
        
        // Reset phases
        for (let i = 1; i <= 5; i++) {
            const phase = document.getElementById(`phase-${i}`);
            phase.classList.remove('active', 'complete', 'error');
            phase.querySelector('.phase-message').textContent = 'ƒêang ch·ªù...';
        }
        
        // Reset progress bar
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        
        // SSE streaming
        const requestBody = { dishName, categories, language };
        if (servingSize) requestBody.servingSize = servingSize;
        
        fetch(`${API_URL}/api/generate-recipe-stream`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        }).then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            function readStream() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        document.getElementById('generateBtn').disabled = false;
                        return;
                    }
                    
                    const text = decoder.decode(value);
                    const lines = text.split('\n');
                    
                    let currentEvent = null;
                    let currentData = '';
                    
                    lines.forEach(line => {
                        if (line.startsWith('event:')) {
                            currentEvent = line.substring(7).trim();
                        } else if (line.startsWith('data:')) {
                            currentData = line.substring(6).trim();
                            
                            if (currentEvent && currentData) {
                                try {
                                    const data = JSON.parse(currentData);
                                    handleEvent(currentEvent, data);
                                } catch (e) {
                                    console.error('Parse error:', e);
                                    showError('L·ªói ph√¢n t√≠ch d·ªØ li·ªáu: ' + e.message);
                                }
                                currentEvent = null;
                                currentData = '';
                            }
                        }
                    });
                    
                    readStream();
                }).catch(err => {
                    showError('L·ªói ƒë·ªçc stream: ' + err.message);
                    document.getElementById('generateBtn').disabled = false;
                });
            }
            
            readStream();
        }).catch(err => {
            showError('L·ªói k·∫øt n·ªëi: ' + err.message);
            document.getElementById('generateBtn').disabled = false;
        });
    }
    
    function handleEvent(event, data) {
        switch (event) {
            case 'phase':
                updatePhase(data.phase, data.message, data.progress, 'active');
                if (data.phase > 1) {
                    updatePhase(data.phase - 1, '', 0, 'complete');
                }
                break;
            case 'rag':
                const phase2 = document.getElementById('phase-2');
                if (phase2) {
                    phase2.querySelector('.phase-message').textContent = data.message;
                }
                break;
            case 'complete':
                updatePhase(5, data.message, 100, 'complete');
                displayRecipe(data.recipe, data.duration);
                document.getElementById('generateBtn').disabled = false;
                break;
            case 'error':
                showError(data.message, data.phase);
                document.getElementById('generateBtn').disabled = false;
                break;
        }
    }
    
    function showError(message, phaseNum) {
        // Show error banner
        const errorBanner = document.getElementById('errorBanner');
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = message;
        errorBanner.classList.add('show');
        
        // Mark current phase as error
        if (phaseNum) {
            const phase = document.getElementById(`phase-${phaseNum}`);
            if (phase) {
                phase.classList.remove('active');
                phase.classList.add('error');
                phase.querySelector('.phase-message').textContent = '‚ùå ' + message;
            }
        }
        
        // Stop all active phases
        for (let i = 1; i <= 5; i++) {
            const p = document.getElementById(`phase-${i}`);
            if (p && p.classList.contains('active') && i !== phaseNum) {
                p.classList.remove('active');
            }
        }
    }
    
    function updatePhase(phaseNum, message, progress, status) {
        const phase = document.getElementById(`phase-${phaseNum}`);
        if (!phase) return;
        
        if (message) {
            const msgEl = phase.querySelector('.phase-message');
            if (msgEl) msgEl.textContent = message;
        }
        
        if (status === 'active') {
            phase.classList.add('active');
            phase.classList.remove('complete');
        } else if (status === 'complete') {
            phase.classList.remove('active');
            phase.classList.add('complete');
        }
        
        if (progress) {
            const bar = document.getElementById('progressBar');
            if (bar) {
                bar.style.width = progress + '%';
                bar.textContent = progress + '%';
            }
        }
    }
    
    function displayRecipe(recipe, duration) {
        document.getElementById('resultContainer').classList.add('active');
        
        let sortedSteps = [];
        if (Array.isArray(recipe.steps)) {
            sortedSteps = recipe.steps.sort((a, b) => a.stepNumber - b.stepNumber);
        }
        
        const html = `
            <div class="recipe-title">${escapeHtml(recipe.dishName)}</div>
            <p style="margin-bottom: 20px; color: #555; line-height: 1.6;">${escapeHtml(recipe.description)}</p>
            <div class="recipe-meta">
                <span>‚è±Ô∏è ${escapeHtml(recipe.prepTime)}</span>
                <span>üî• ${escapeHtml(recipe.cookTime)}</span>
                <span>üë• ${escapeHtml(recipe.servings)}</span>
                <span>‚ö° ${duration}</span>
            </div>
            <div class="recipe-section">
                <h3>üìù Nguy√™n li·ªáu (${recipe.ingredients.length})</h3>
                ${recipe.ingredients.map((ing, idx) => 
                    `<div class="ingredient-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <span style="color: #667eea; font-weight: 600;">${idx + 1}.</span>
                                ${escapeHtml(ing.name)}: <strong>${escapeHtml(ing.quantity)}</strong>
                            </div>
                            ${ing.whereToFind ? `<div style="font-size: 12px; color: #999; text-align: right;">
                                üìç ${escapeHtml(ing.whereToFind)}
                            </div>` : ''}
                        </div>
                    </div>`
                ).join('')}
                ${recipe.shoppingTips ? `
                    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ffc107;">
                        <strong style="color: #856404;">üí° M·∫πo mua s·∫Øm:</strong><br>
                        <span style="color: #856404; font-size: 14px;">${escapeHtml(recipe.shoppingTips)}</span>
                    </div>
                ` : ''}
            </div>
            <div class="recipe-section">
                <h3>üë®‚Äçüç≥ C√°c b∆∞·ªõc th·ª±c hi·ªán (${sortedSteps.length})</h3>
                ${sortedSteps.map(step => `
                    <div class="step-item">
                        <strong style="color: #667eea;">${step.stepNumber}.</strong>
                        ${escapeHtml(step.description)}
                        ${step.videoUrl ? `
                            <div style="margin-top: 10px;">
                                <a href="${escapeHtml(step.videoUrl)}" target="_blank" 
                                   style="display: inline-block; padding: 6px 12px; background: #ff0000; color: white; text-decoration: none; border-radius: 6px; font-size: 13px;">
                                    ‚ñ∂Ô∏è Xem video h∆∞·ªõng d·∫´n
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        `;
        
        document.getElementById('recipeCard').innerHTML = html;
        document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }
</script>

<%- include('partials/footer') %>

